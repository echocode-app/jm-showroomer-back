# Analytics Contract (Backend, MVP)

## 1. Canonical Envelope

All analytics events are stored in a canonical envelope with these top-level fields:

- `eventId`
- `eventName`
- `schemaVersion`
- `eventVersion`
- `timestamp`
- `user`
- `context`
- `resource`
- `meta`

`eventId` is always generated on the server.

## 2. Server-Generated Events

Current server-generated events:

- `auth_completed`
- `auth_failed`
- `showroom_favorite`
- `showroom_unfavorite`
- `lookbook_favorite`
- `lookbook_unfavorite`
- `event_want_to_visit`
- `event_remove_want_to_visit`
- `showroom_create_started`
- `showroom_submit_for_review`
- `showroom_view`
- `lookbook_view`
- `event_view`

Explicitly absent (current backend implementation):

- moderation approve/reject analytics events (`approve`, `reject`) are **not** part of `ANALYTICS_EVENTS`
- admin moderation actions use domain logs + notifications, not analytics

## 3. Client-Generated Events

Client-originated analytics events are accepted via:

- `POST /api/v1/analytics/ingest`

Backend validates input, builds the canonical envelope, and stores the event in Firestore `analytics_events`.

## Client-Originated Events (MVP1)

Contractual client-originated events for mobile integration:

Lifecycle:

- `app_opened`
- `session_started`

Onboarding/Auth:

- `splash_view`
- `onboarding_step_view`
- `onboarding_completed`
- `continue_as_guest`
- `auth_started`

Navigation:

- `screen_view`

Search:

- `search_executed`
- `filter_applied`

Backend phase note:

- In the current backend implementation, ingest whitelist is enforced from `ANALYTICS_EVENTS` registry.
- Events not present in registry are rejected with `EVENT_NAME_INVALID` (HTTP 400).
- The list above is the client integration contract and must be enabled via registry in a future backend pass before mobile starts sending them in production.

## Event Origin Matrix

| Event                        | Origin | Emitter                                         |
| ---------------------------- | ------ | ----------------------------------------------- |
| `auth_completed`             | server | backend                                         |
| `auth_failed`                | server | backend                                         |
| `showroom_favorite`          | server | backend                                         |
| `showroom_unfavorite`        | server | backend                                         |
| `lookbook_favorite`          | server | backend                                         |
| `lookbook_unfavorite`        | server | backend                                         |
| `event_want_to_visit`        | server | backend                                         |
| `event_remove_want_to_visit` | server | backend                                         |
| `showroom_create_started`    | server | backend                                         |
| `showroom_create_submitted`  | server | backend (reserved in registry; not emitted yet) |
| `showroom_submit_for_review` | server | backend                                         |
| `showroom_view`              | server | backend                                         |
| `lookbook_view`              | server | backend                                         |
| `event_view`                 | server | backend                                         |
| `app_opened`                 | client | mobile                                          |
| `session_started`            | client | mobile                                          |
| `splash_view`                | client | mobile                                          |
| `onboarding_step_view`       | client | mobile                                          |
| `onboarding_completed`       | client | mobile                                          |
| `continue_as_guest`          | client | mobile                                          |
| `auth_started`               | client | mobile                                          |
| `screen_view`                | client | mobile                                          |
| `search_executed`            | client | mobile                                          |
| `filter_applied`             | client | mobile                                          |

## Client / Server Responsibility Rules

- Detail `*_view` events (`showroom_view`, `lookbook_view`, `event_view`) are emitted only by backend.
- State-transition analytics events (favorites, want-to-visit, showroom submit/create auth completion/failure) are emitted only by backend.
- Admin moderation approve/reject are not analytics events in MVP and should not be expected in analytics streams.
- Client must not duplicate server-generated events.
- Client must not send events that are not present in the backend `ANALYTICS_EVENTS` registry.
- Client-originated events should use `/api/v1/analytics/ingest` only.

## Session Model (Client Responsibilities)

- `sessionId` is generated by client on cold start.
- `sessionId` is short-lived and should not be treated as a long-term identifier.
- `sessionId` must be sent in `context.sessionId` for client-originated events.
- Backend does not generate `sessionId` for client-originated events.

## Anonymous Identity Contract

- Client generates and persists a stable anonymous identifier.
- Client sends it in `x-anonymous-id` header.
- Client should not rotate anonymousId between sessions unless local identity is intentionally reset.
- Backend canonicalizes anonymous actor identity as `a:<anonymousId>`.

## Client Ingest Policy

- Max batch size: `50` events per request.
- Recommended batching: small periodic flush (for example every 2-10 seconds) and app lifecycle flushes.
- Analytics failures must not block UI flows.
- Malformed payloads / disallowed event names are rejected by backend with `4xx`.
- Storage writes are best-effort; analytics persistence failures must not block business behavior.
- `/analytics/ingest` uses a separate rate-limiter bucket and does not consume business endpoint quota.

## Client Payload Governance (Backend Sanitizer)

Backend applies a non-breaking sanitizer to client-provided analytics objects:

- `context`
- `meta`
- `resource.attributes`

Rules:

- Max depth: `2`
- Max array length: `20`
- Per-event combined client payload budget (`context + meta + resource.attributes`): ~`4KB`
- Oversized payload sections are truncated (event is not rejected for this reason alone)

Blocked keys (case-insensitive, removed at any nested level):

- `email`
- `phone`
- `password`
- `token`
- `idToken`
- `authorization`
- `cookie`
- `fcmToken`
- `refreshToken`

## Soft Shape Warnings (Non-blocking)

For event names ending with:

- `_view`
- `_favorite`
- `_want_to_visit`

backend expects `resource.type` and `resource.id`.

If missing:

- backend logs a warning (`analytics_invalid_shape`)
- event is still accepted and stored (non-breaking behavior)

## Logging / Observability Guarantees (Analytics Ingest)

- `/analytics/ingest` does **not** emit domain logs
- request-level logs still apply (pino/pino-http)
- analytics storage failures are logged with request correlation when ingest is called over HTTP

## 4. Anti-Storm Policy

Detail view events use backend-side throttle:

- max `1` emit per `10s` per `actor + resource`
- in-memory throttle (`Map`)
- per-instance only
- emit is non-blocking (`record(...).catch(...)`)

This is MVP-safe and can be upgraded to Redis in MVP2.

## 5. Invariants

- Analytics is never emitted inside Firestore transaction callbacks
- Analytics never blocks business flow
- `eventId` is always server-generated
- canonical `actorId` format:
  - `u:<uid>`
  - `a:<anonymousId>`

## Schema Freeze Policy (MVP1)

- `schemaVersion = 1`
- `eventVersion = 1`
- Breaking changes require version bump
- `eventName` must exist in `ANALYTICS_EVENTS` registry
- `eventName` must be `snake_case`
- All server events must use registry constant (no string literals)
