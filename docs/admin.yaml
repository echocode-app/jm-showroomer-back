paths:
  /admin/showrooms:
    get:
      tags: [Admin]
      summary: List showrooms (admin)
      description: |
        Admin showroom list.
        Requires explicit `status` filter.

        `status=pending` activates moderation queue mode:
        - deterministic ordering by `submittedAt desc` + document id tie-breaker
        - admin-specific queue DTO (minimal moderation payload)
        - dedicated v3 cursor with moderation fingerprint validation
        - only `status`, `limit`, `cursor` query params are accepted in this mode

        For non-pending statuses, backend uses the shared showroom list engine and returns
        the same nested paging envelope shape (`data.showrooms.{showrooms,meta}`).
      operationId: listShowroomsAdmin
      externalDocs:
        description: Flutter guide for admin pending queue cursor pagination
        url: https://github.com/echocode-app/jm-showroomer-back/blob/main/docs/readme/ADMIN_PENDING_QUEUE_CURSOR.md
      security:
        - bearerAuth: []
      x-roles: [admin]
      parameters:
        - name: status
          in: query
          required: true
          schema:
            type: string
            enum: [draft, pending, approved, rejected, deleted]
          description: Explicit admin status filter. `pending` enables moderation queue mode.
        - name: country
          in: query
          schema:
            type: string
          description: Shared showroom list filter (non-pending admin modes).
        - name: city
          in: query
          schema:
            type: string
          description: Shared showroom list filter (non-pending admin modes).
        - name: type
          in: query
          schema:
            type: string
          description: Shared showroom list filter (non-pending admin modes).
        - name: availability
          in: query
          schema:
            type: string
          description: Shared showroom list filter (non-pending admin modes).
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
          description: |
            Opaque backend cursor from previous response.
            In moderation queue mode (`status=pending`) backend uses a dedicated v3 moderation cursor.
      responses:
        "200":
          description: Showrooms list (nested list envelope inside `data.showrooms`)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          showrooms:
                            $ref: '#/components/schemas/AdminShowroomsListEnvelope'
        "400":
          description: Invalid query or cursor
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "503":
          description: Required Firestore index is not ready
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /admin/showrooms/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Showroom ID
    get:
      tags: [Admin]
      summary: Get showroom by ID (admin)
      description: |
        Returns privileged showroom detail for admin.

        If showroom status is `pending`, backend returns a wrapper object with:
        - `canonical` (current document state)
        - `pendingSnapshot` (frozen moderation snapshot)
        - `diff` (currently `null`, reserved for future server-side diff)
      operationId: getShowroomAdmin
      security:
        - bearerAuth: []
      x-roles: [admin]
      responses:
        "200":
          description: Showroom detail (direct privileged DTO or pending wrapper)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          showroom:
                            oneOf:
                              - $ref: './showrooms.yaml#/components/schemas/ShowroomPrivileged'
                              - $ref: '#/components/schemas/AdminPendingShowroomDetail'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
    delete:
      tags: [Admin]
      summary: Soft-delete showroom (admin)
      description: |
        Admin soft delete for any showroom status.
        Returns privileged showroom payload after status is changed to `deleted`.
      operationId: deleteShowroomAdmin
      security:
        - bearerAuth: []
      x-roles: [admin]
      responses:
        "200":
          description: Showroom deleted
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          showroom:
                            $ref: './showrooms.yaml#/components/schemas/ShowroomPrivileged'
        "400":
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /admin/showrooms/{id}/history:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Showroom ID
    get:
      tags: [Admin]
      summary: Get showroom edit/moderation history (admin)
      description: |
        Returns showroom `editHistory` entries sorted newest-first (server sorts on read).
        Read-only endpoint: no Firestore writes, no transaction, no analytics events.
      operationId: getShowroomHistoryAdmin
      security:
        - bearerAuth: []
      x-roles: [admin]
      responses:
        "200":
          description: Showroom history
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/AdminShowroomHistoryResponse'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Showroom not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /admin/showrooms/{id}/stats:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Showroom ID
    get:
      tags: [Admin]
      summary: Get showroom lifecycle/moderation stats (admin)
      description: |
        Derives read-only stats from showroom fields and `editHistory`.
        Read-only endpoint: no Firestore writes, no transaction, no analytics events.
      operationId: getShowroomStatsAdmin
      security:
        - bearerAuth: []
      x-roles: [admin]
      responses:
        "200":
          description: Showroom stats
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/AdminShowroomStats'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Showroom not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /admin/showrooms/{id}/approve:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Showroom ID
    post:
      tags: [Admin]
      summary: Approve showroom
      description: |
        Approves only `pending` showrooms.
        Backend applies the immutable `pendingSnapshot` to canonical editable fields inside a Firestore transaction,
        appends moderation history, increments `editCount`, clears `pendingSnapshot`, and clears stale `reviewReason`.
        Owner notification is emitted post-commit (best-effort). No analytics event is emitted for approve.
      operationId: approveShowroom
      security:
        - bearerAuth: []
      x-roles: [admin]
      responses:
        "200":
          description: Showroom approved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          showroom:
                            $ref: './showrooms.yaml#/components/schemas/ShowroomPrivileged'
        "400":
          description: Not editable (must be pending)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "409":
          description: Pending snapshot missing
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /admin/showrooms/{id}/reject:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Showroom ID
    post:
      tags: [Admin]
      summary: Reject showroom
      description: |
        Rejects only `pending` showrooms.
        Backend validates reason (minimum 3 chars), trims it, stores the normalized value in `reviewReason`,
        appends moderation history, increments `editCount`, and clears `pendingSnapshot` in one transaction.
        Owner notification is emitted post-commit (best-effort). No analytics event is emitted for reject.
      operationId: rejectShowroom
      security:
        - bearerAuth: []
      x-roles: [admin]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required: [reason]
              properties:
                reason:
                  type: string
                  minLength: 3
                  description: |
                    Rejection reason. Backend trims whitespace before validation/storage.
                    Empty/short (after trim) returns `VALIDATION_ERROR`.
      responses:
        "200":
          description: Showroom rejected
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          showroom:
                            $ref: './showrooms.yaml#/components/schemas/ShowroomPrivileged'
        "400":
          description: Validation error or not editable (must be pending)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

components:
  schemas:
    AdminPagingMeta:
      type: object
      description: Standard cursor pagination meta used by admin showroom list flows.
      required: [nextCursor, hasMore, paging]
      properties:
        nextCursor:
          type: string
          nullable: true
          description: Opaque backend cursor token (v3 in moderation queue mode; shared list cursor otherwise).
        hasMore:
          type: boolean
        paging:
          type: string
          enum: [enabled, end, disabled]
        reason:
          type: string
          nullable: true
          description: Present only when paging is disabled for a specific mode.

    AdminModerationQueueItem:
      type: object
      description: Admin pending moderation queue item DTO (minimal, whitelist-only).
      properties:
        id:
          type: string
        name:
          type: string
          nullable: true
        type:
          type: string
          nullable: true
        country:
          type: string
          nullable: true
        city:
          type: string
          nullable: true
        ownerUid:
          type: string
          nullable: true
        submittedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true
        editCount:
          type: integer
        status:
          type: string
      required: [id, ownerUid, status, submittedAt, createdAt, updatedAt, editCount]

    AdminShowroomsListItem:
      oneOf:
        - $ref: '#/components/schemas/AdminModerationQueueItem'
        - $ref: './showrooms.yaml#/components/schemas/Showroom'
      description: |
        Item shape depends on admin list mode:
        - `status=pending` => moderation queue item DTO
        - other statuses => shared showroom list DTO

    AdminShowroomsListEnvelope:
      type: object
      required: [showrooms, meta]
      properties:
        showrooms:
          type: array
          items:
            $ref: '#/components/schemas/AdminShowroomsListItem'
        meta:
          $ref: '#/components/schemas/AdminPagingMeta'

    AdminPendingShowroomDetail:
      type: object
      description: Pending admin detail wrapper exposing canonical doc and immutable moderation snapshot.
      required: [canonical, pendingSnapshot, diff]
      properties:
        canonical:
          $ref: './showrooms.yaml#/components/schemas/ShowroomPrivileged'
        pendingSnapshot:
          type: object
          nullable: true
          additionalProperties: true
        diff:
          type: object
          nullable: true
          additionalProperties: true

    AdminShowroomHistoryMeta:
      type: object
      required: [total]
      properties:
        total:
          type: integer
          minimum: 0

    AdminShowroomHistoryResponse:
      type: object
      required: [history, meta]
      properties:
        history:
          type: array
          description: Newest-first sorted copy of showroom `editHistory`.
          items:
            type: object
            additionalProperties: true
        meta:
          $ref: '#/components/schemas/AdminShowroomHistoryMeta'

    AdminShowroomModerationStats:
      type: object
      required:
        [approveCount, rejectCount, submitCount, lastReviewedAt, lastReviewedBy]
      properties:
        approveCount:
          type: integer
          minimum: 0
        rejectCount:
          type: integer
          minimum: 0
        submitCount:
          type: integer
          minimum: 0
        lastReviewedAt:
          type: string
          format: date-time
          nullable: true
        lastReviewedBy:
          type: object
          nullable: true
          additionalProperties: true

    AdminShowroomLifecycleStats:
      type: object
      required: [createdAt, lastUpdatedAt, currentStatus]
      properties:
        createdAt:
          type: string
          format: date-time
          nullable: true
        lastUpdatedAt:
          type: string
          format: date-time
          nullable: true
        currentStatus:
          type: string
          nullable: true
          enum: [draft, pending, approved, rejected, deleted]

    AdminShowroomStats:
      type: object
      required: [editCount, moderation, lifecycle]
      properties:
        editCount:
          type: integer
          minimum: 0
          description: Source of truth is `showroom.editCount`.
        moderation:
          $ref: '#/components/schemas/AdminShowroomModerationStats'
        lifecycle:
          $ref: '#/components/schemas/AdminShowroomLifecycleStats'
