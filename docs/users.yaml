components:
  schemas:
    User:
      type: object
      required: [uid, role, roles, status, onboardingState]
      properties:
        uid:
          type: string
        email:
          type: string
          nullable: true
        name:
          type: string
          nullable: true
        avatar:
          type: string
          nullable: true
        role:
          type: string
          enum: [guest, user, owner, admin, manager, stylist]
          description: Roles manager/stylist are reserved for future (MVP2) and not currently assignable via public API.
        roles:
          type: array
          items:
            type: string
          description: MVP1 uses single-role values (guest/user/owner/admin). Multi-role support is reserved for MVP2.
        status:
          type: string
        onboardingState:
          type: string
          enum: [new, completed]
        country:
          type: string
          nullable: true
          description: Full country name (e.g., Ukraine). Not ISO2.
        appLanguage:
          type: string
          nullable: true
        notificationsEnabled:
          type: boolean
          nullable: true
        roleRequest:
          type: object
          nullable: true
          description: Reserved for future role upgrade workflows (MVP2); unused in MVP1.
          properties:
            role:
              type: string
            status:
              type: string
            requestedAt:
              type: string
              format: date-time
            reviewedAt:
              type: string
              format: date-time
              nullable: true
            reviewedBy:
              type: string
              nullable: true
            reason:
              type: string
              nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        isDeleted:
          type: boolean
          nullable: true
        deletedAt:
          type: string
          format: date-time
          nullable: true
        ownerProfile:
          type: object
          nullable: true
          properties:
            name:
              type: string
            position:
              type: string
              nullable: true
            instagram:
              type: string

    CompleteOnboardingInput:
      type: object
      required: [country]
      properties:
        country:
          type: string
          description: Full country name (e.g., Ukraine). Not ISO2. russia/belarus blocked.

    CompleteOwnerProfileInput:
      type: object
      required: [name, country, instagram]
      properties:
        name:
          type: string
        position:
          type: string
          nullable: true
        country:
          type: string
          description: Full country name (e.g., Ukraine). Not ISO2. russia/belarus blocked.
        instagram:
          type: string
    UserProfileUpdateInput:
      type: object
      minProperties: 1
      properties:
        name:
          type: string
        country:
          type: string
          description: Full country name (e.g., Ukraine). Not ISO2. russia/belarus blocked.
        instagram:
          type: string
          description: Owner-only field (role=owner). Non-owners get 403 FORBIDDEN.
        position:
          type: string
          nullable: true
          description: Owner-only field (role=owner). Non-owners get 403 FORBIDDEN.
        appLanguage:
          type: string
        notificationsEnabled:
          type: boolean
    DeviceRegisterRequest:
      type: object
      required: [deviceId, fcmToken, platform]
      additionalProperties: false
      properties:
        deviceId:
          type: string
        fcmToken:
          type: string
        platform:
          type: string
          enum: [ios, android]
        appVersion:
          type: string
          nullable: true
        locale:
          type: string
          nullable: true
    DeviceResponse:
      type: object
      required: [success]
      properties:
        success:
          type: boolean
          example: true
    NotificationReadResult:
      type: object
      required: [id, isRead]
      properties:
        id:
          type: string
        isRead:
          type: boolean
          example: true
    NotificationsListData:
      type: object
      required: [items, meta]
      properties:
        items:
          type: array
          items:
            $ref: './common.yaml#/components/schemas/Notification'
        meta:
          type: object
          required: [nextCursor, hasMore]
          properties:
            nextCursor:
              type: string
              nullable: true
            hasMore:
              type: boolean
    NotificationsUnreadCountData:
      type: object
      required: [unreadCount]
      properties:
        unreadCount:
          type: integer
          minimum: 0

    SyncGuestEventsInput:
      type: object
      additionalProperties: false
      properties:
        wantToVisitIds:
          type: array
          maxItems: 100
          items:
            type: string
        dismissedIds:
          type: array
          maxItems: 100
          items:
            type: string
      description: |
        Guest-local state sync payload. If the same id appears in both lists, server applies want-to-visit and drops dismiss for that id.

    SyncGuestEventsResult:
      type: object
      properties:
        applied:
          type: object
          properties:
            wantToVisit:
              type: array
              items:
                type: string
            dismissed:
              type: array
              items:
                type: string
        skipped:
          type: array
          description: Event ids skipped due to not found, unpublished, blocked country, or past start time.
          items:
            type: string

    SyncGuestLookbookFavoritesInput:
      type: object
      additionalProperties: false
      properties:
        favoriteIds:
          type: array
          maxItems: 100
          items:
            type: string
      description: Guest-local lookbook favorites sync payload.

    SyncGuestLookbookFavoritesResult:
      type: object
      properties:
        applied:
          type: object
          properties:
            favorites:
              type: array
              items:
                type: string
        skipped:
          type: array
          description: Lookbook ids skipped due to not found or unpublished state.
          items:
            type: string

    SyncGuestShowroomFavoritesInput:
      type: object
      additionalProperties: false
      properties:
        favoriteIds:
          type: array
          maxItems: 100
          items:
            type: string
      description: Guest-local showroom favorites sync payload.

    SyncGuestShowroomFavoritesResult:
      type: object
      properties:
        applied:
          type: object
          properties:
            favorites:
              type: array
              items:
                type: string
        skipped:
          type: array
          description: Showroom ids skipped due to not found or non-approved state.
          items:
            type: string

paths:
  /users/me:
    get:
      tags: [Users]
      summary: Get current user
      operationId: getMyProfile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/User'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: User not found (deleted users return 404)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
    delete:
      tags: [Users]
      summary: Delete current user (soft-delete)
      operationId: deleteMyProfile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User deleted (idempotent)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "409":
          description: Delete blocked (active assets, USER_DELETE_BLOCKED)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /users/me/notifications:
    get:
      tags: [Users]
      summary: List my notifications
      description: |
        Returns notifications for current authenticated user only.
        Ordered by `createdAt desc`, then `documentId desc`.
        Cursor is backend-owned base64 JSON `{ v, createdAt, id }`.
      operationId: listMyNotifications
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Page size (values are clamped to 1..100; default 20).
        - in: query
          name: cursor
          schema:
            type: string
          description: Opaque backend cursor from previous response.
      responses:
        "200":
          description: Notifications list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/NotificationsListData'
        "400":
          description: Invalid query or cursor
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /users/me/notifications/{notificationId}/read:
    patch:
      tags: [Users]
      summary: Mark notification as read
      operationId: markMyNotificationRead
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: notificationId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Notification marked as read (idempotent)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/NotificationReadResult'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Notification not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /users/me/notifications/unread-count:
    get:
      tags: [Users]
      summary: Get unread notifications count
      description: |
        Computes unread count server-side with Firestore query
        `where("isRead", "==", false)`.
      operationId: getMyUnreadNotificationsCount
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Unread count
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/NotificationsUnreadCountData'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "503":
          description: Index not ready (if required in specific Firestore env)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /users/me/devices:
    post:
      tags: [Users]
      summary: Register or update current user device for push
      operationId: registerMyDevice
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeviceRegisterRequest'
      responses:
        "200":
          description: Device upserted
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/DeviceResponse'
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /users/me/devices/{deviceId}:
    delete:
      tags: [Users]
      summary: Delete current user device
      operationId: deleteMyDevice
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: deviceId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Device removed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/DeviceResponse'
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /users/complete-onboarding:
    post:
      tags: [Users]
      summary: Complete onboarding
      operationId: completeOnboarding
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteOnboardingInput'
      responses:
        "200":
          description: Onboarding completed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
        "400":
          description: Missing country
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Country blocked
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /users/complete-owner-profile:
    post:
      tags: [Users]
      summary: Complete owner profile and auto-upgrade to owner
      operationId: completeOwnerProfile
      security:
        - bearerAuth: []
      x-roles: [user, owner]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteOwnerProfileInput'
      responses:
        "200":
          description: Owner profile completed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
                          role:
                            type: string
                            example: owner
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Country blocked
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /users/profile:
    patch:
      tags: [Users]
      summary: Update user profile
      description: Requires Bearer auth. Fields instagram/position are owner-only; non-owners receive 403 FORBIDDEN.
      operationId: updateUserProfile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfileUpdateInput'
      responses:
        "200":
          description: Profile updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized (AUTH_MISSING or AUTH_INVALID)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "403":
          description: Forbidden (owner-only fields) or country blocked
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "409":
          description: Country change blocked (owner has active showrooms/lookbooks/events)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /collections/favorites/showrooms:
    get:
      tags: [Collections]
      summary: Favorite showrooms
      description: |
        Guest mode returns an empty list.
        Auth mode returns current user favorite showrooms, revalidated as approved-only.
        Supports cursor pagination.
      operationId: listFavoriteShowrooms
      security: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
          description: Server-issued base64 cursor
      responses:
        "200":
          description: Favorites list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: './showrooms.yaml#/components/schemas/Showroom'
                      meta:
                        type: object
                        properties:
                          hasMore:
                            type: boolean
                          nextCursor:
                            type: string
                            nullable: true
        "400":
          description: Invalid query (`QUERY_INVALID`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /collections/favorites/showrooms/sync:
    post:
      tags: [Collections]
      summary: Sync guest showroom favorites after login
      description: |
        Auth-only batch sync for guest-local showroom favorites.
        Server applies only approved showrooms.
        Max 100 ids.
        Unknown/non-approved ids are returned in `skipped`.
        Endpoint is idempotent.
      operationId: syncGuestShowrooms
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncGuestShowroomFavoritesInput'
      responses:
        "200":
          description: Sync result
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/SyncGuestShowroomFavoritesResult'
        "400":
          description: Invalid payload (`QUERY_INVALID`) or size limit exceeded (`SHOWROOM_SYNC_LIMIT_EXCEEDED`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /collections/favorites/lookbooks:
    get:
      tags: [Collections]
      summary: Favorite lookbooks
      description: |
        Public-compatible endpoint.
        Guest mode returns an empty list.
        Auth mode returns current user favorite lookbooks (published-only revalidation).
      operationId: listFavoriteLookbooks
      security: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: Favorite lookbooks list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: './lookbooks.yaml#/components/schemas/Lookbook'
                      meta:
                        type: object
                        properties:
                          total:
                            type: integer
                          returned:
                            type: integer
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /collections/favorites/lookbooks/sync:
    post:
      tags: [Collections]
      summary: Sync guest lookbook favorites after login
      description: |
        Auth-only batch sync for guest-local lookbook favorites.
        Server validates ids and applies only published lookbooks.
        Sync also reconciles canonical likes state (`lookbooks/{id}/likes/{u:uid}`) and updates `likesCount` idempotently.
        Mirror favorites in `users/{uid}/lookbooks_favorites` remain as a projection for collections reads.
        Max 100 ids.
        Unknown/unpublished ids are returned in `skipped`.
        Endpoint is idempotent.
      operationId: syncGuestLookbooks
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncGuestLookbookFavoritesInput'
      responses:
        "200":
          description: Sync result
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/SyncGuestLookbookFavoritesResult'
        "400":
          description: Invalid payload (`QUERY_INVALID`) or size limit exceeded (`LOOKBOOK_SYNC_LIMIT_EXCEEDED`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /collections/want-to-visit/events:
    get:
      tags: [Collections]
      summary: Events marked as want-to-visit
      description: |
        Public-compatible endpoint.
        Guest mode returns an empty list.
        Auth mode returns upcoming published events from user want-to-visit collection (past excluded).
      operationId: listWantToVisitEvents
      security: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: Events list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: './events.yaml#/components/schemas/EventListItem'
                      meta:
                        type: object
                        properties:
                          total:
                            type: integer
                            description: Total upcoming events after server-side filtering (before limit).
                          returned:
                            type: integer
                            description: Number of items returned in this response.
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /collections/want-to-visit/events/sync:
    post:
      tags: [Collections]
      summary: Sync guest event state after login
      description: |
        Auth-only batch sync for guest-local event likes/dismiss state.
        Server validates each id and applies only upcoming published events from non-blocked countries.
        Max 100 ids per list. If the same id is present in both lists, want-to-visit wins.
        Unknown/unpublished/blocked/past ids are returned in `skipped`.
        Endpoint is idempotent.
      operationId: syncGuestEvents
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncGuestEventsInput'
            examples:
              basic:
                value:
                  wantToVisitIds: ["event_1", "event_2"]
                  dismissedIds: ["event_3"]
      responses:
        "200":
          description: Sync result
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        $ref: '#/components/schemas/SyncGuestEventsResult'
        "400":
          description: Invalid payload (`QUERY_INVALID`) or size limit exceeded (`EVENT_SYNC_LIMIT_EXCEEDED`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
