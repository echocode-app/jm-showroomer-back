components:
  schemas:
    LookbookImage:
      type: object
      properties:
        storagePath:
          type: string
          description: Canonical Storage path.
        order:
          type: integer
        url:
          type: string
          nullable: true
          description: Signed read URL (detail endpoint only).

    LookbookAuthor:
      type: object
      properties:
        name:
          type: string
        position:
          type: string
          nullable: true
        instagram:
          type: string
          nullable: true
          format: uri

    LookbookItem:
      type: object
      properties:
        name:
          type: string
        link:
          type: string
          format: uri

    Lookbook:
      type: object
      properties:
        id:
          type: string
        imageUrl:
          type: string
          nullable: true
        showroomId:
          type: string
          nullable: true
        authorId:
          type: string
          nullable: true
        likesCount:
          type: integer
          nullable: true
        likedByMe:
          type: boolean
          description: True when current auth/anonymous actor liked this lookbook.
        title:
          type: string
          nullable: true
        name:
          type: string
          nullable: true
          description: Backward-compatible alias for title.
        description:
          type: string
          nullable: true
        author:
          type: object
          allOf:
            - $ref: '#/components/schemas/LookbookAuthor'
          nullable: true
        items:
          type: array
          items:
            $ref: '#/components/schemas/LookbookItem'
        country:
          type: string
          nullable: true
        countryNormalized:
          type: string
          nullable: true
        city:
          type: string
          nullable: true
        cityNormalized:
          type: string
          nullable: true
        seasonLabel:
          type: string
          nullable: true
        seasonKey:
          type: string
          nullable: true
        sortRank:
          type: integer
          nullable: true
        coverPath:
          type: string
          nullable: true
        coverUrl:
          type: string
          nullable: true
          description: Signed read URL for cover image.
        images:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/LookbookImage'
        source:
          type: string
          enum: [seed, owner, admin]
          nullable: true
        published:
          type: boolean
          nullable: true
        publishedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true

paths:
  /lookbooks:
    get:
      tags: [Lookbooks]
      summary: List lookbooks
      description: |
        Public list endpoint.
        By default returns published lookbooks ordered by createdAt desc.
        Optional filter by showroomId is supported.
        Legacy MVP1 filter mode (country + seasonKey) remains supported for compatibility.
        Signed URL is generated for coverPath only.
      operationId: listLookbooks
      security: []
      parameters:
        - name: country
          in: query
          required: false
          schema:
            type: string
        - name: seasonKey
          in: query
          required: false
          schema:
            type: string
            example: ss-2026
        - name: showroomId
          in: query
          required: false
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
          description: Cursor as last document id from previous page.
      responses:
        "200":
          description: Lookbooks list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          lookbooks:
                            type: array
                            items:
                              $ref: '#/components/schemas/Lookbook'
                      meta:
                        type: object
                        properties:
                          hasMore:
                            type: boolean
                          nextCursor:
                            type: string
                            nullable: true
                          paging:
                            type: string
                            enum: [enabled, end]
        "400":
          description: Invalid query or cursor
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "503":
          description: Missing required Firestore index (INDEX_NOT_READY)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
    post:
      tags: [Lookbooks]
      summary: Create lookbook
      description: |
        Public-compatible create.
        Auth users are stored as owner (`authorId=uid`); guests use `x-anonymous-id`.
        If guest id header is missing, backend generates and returns it in `x-anonymous-id` response header.
      operationId: createLookbook
      security: []
      parameters:
        - name: x-anonymous-id
          in: header
          required: false
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [imageUrl, showroomId]
              properties:
                imageUrl:
                  type: string
                  format: uri
                showroomId:
                  type: string
                description:
                  type: string
                  maxLength: 1000
                author:
                  $ref: '#/components/schemas/LookbookAuthor'
                items:
                  type: array
                  maxItems: 30
                  items:
                    $ref: '#/components/schemas/LookbookItem'
      responses:
        "201":
          description: Lookbook created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          lookbook:
                            $ref: '#/components/schemas/Lookbook'
        "400":
          description: Validation error (`VALIDATION_ERROR`) or invalid anonymous id (`ANON_ID_INVALID`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /lookbooks/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [Lookbooks]
      summary: Get lookbook by id
      description: Returns published lookbook for public callers. Owners can access their own unpublished docs.
      operationId: getLookbookById
      security: []
      responses:
        "200":
          description: Lookbook details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          lookbook:
                            $ref: '#/components/schemas/Lookbook'
        "404":
          description: Not found or unpublished
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
    patch:
      tags: [Lookbooks]
      summary: Update lookbook
      description: |
        Public-compatible update with ownership validation.
        Allowed when current actor matches `authorId` (auth) or `x-anonymous-id` (guest).
      operationId: updateLookbook
      security: []
      parameters:
        - name: x-anonymous-id
          in: header
          required: false
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                imageUrl:
                  type: string
                  format: uri
                showroomId:
                  type: string
                description:
                  type: string
                  nullable: true
                  maxLength: 1000
                author:
                  type: object
                  allOf:
                    - $ref: '#/components/schemas/LookbookAuthor'
                  nullable: true
                items:
                  type: array
                  nullable: true
                  maxItems: 30
                  items:
                    $ref: '#/components/schemas/LookbookItem'
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiSuccess'
        "403":
          description: Not owner
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "400":
          description: Validation error (`VALIDATION_ERROR`) or invalid anonymous id (`ANON_ID_INVALID`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
    delete:
      tags: [Lookbooks]
      summary: Delete lookbook
      description: Public-compatible delete with ownership validation.
      operationId: deleteLookbook
      security: []
      parameters:
        - name: x-anonymous-id
          in: header
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiSuccess'
        "403":
          description: Not owner
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "400":
          description: Invalid anonymous id (`ANON_ID_INVALID`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /lookbooks/{id}/favorite:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      tags: [Lookbooks]
      summary: Add lookbook to favorites
      description: |
        Public-compatible like (idempotent).
        Auth uses uid; guest uses `x-anonymous-id`.
      operationId: favoriteLookbook
      security: []
      parameters:
        - name: x-anonymous-id
          in: header
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Favorited
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          lookbookId:
                            type: string
                          status:
                            type: string
                            example: favorited
        "404":
          description: Lookbook not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "400":
          description: Invalid anonymous id (`ANON_ID_INVALID`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
    delete:
      tags: [Lookbooks]
      summary: Remove lookbook from favorites
      description: Public-compatible unlike (idempotent).
      operationId: unfavoriteLookbook
      security: []
      parameters:
        - name: x-anonymous-id
          in: header
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Removed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          lookbookId:
                            type: string
                          status:
                            type: string
                            example: removed
        "404":
          description: Lookbook not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "400":
          description: Invalid anonymous id (`ANON_ID_INVALID`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /lookbooks/create:
    post:
      tags: [Lookbooks]
      summary: Create lookbook (legacy alias)
      description: Backward-compatible alias for `POST /lookbooks`.
      operationId: createLookbookLegacyAlias
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [imageUrl, showroomId]
              properties:
                imageUrl:
                  type: string
                  format: uri
                showroomId:
                  type: string
                description:
                  type: string
                  maxLength: 1000
                author:
                  $ref: '#/components/schemas/LookbookAuthor'
                items:
                  type: array
                  maxItems: 30
                  items:
                    $ref: '#/components/schemas/LookbookItem'
      responses:
        "201":
          description: Lookbook created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          lookbook:
                            type: object
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /lookbooks/{id}/rsvp:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      tags: [Lookbooks]
      summary: RSVP to lookbook (stub)
      description: MVP2. Stub in MVP1.
      operationId: rsvpLookbook
      security:
        - bearerAuth: []
      responses:
        "200":
          description: RSVP response
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          lookbookId:
                            type: string
                          user:
                            type: string
                          status:
                            type: string
                            example: RSVPed
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
