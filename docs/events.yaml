components:
  schemas:
    EventBase:
      type: object
      required: [id, name, startsAt, published]
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        type:
          type: string
          nullable: true
          description: Event tag/type for UI badges (e.g., pop_up, fashion_week).
        country:
          type: string
          nullable: true
          description: Full country name (e.g., Ukraine). Not ISO2.
        city:
          type: string
          nullable: true
        address:
          type: string
          nullable: true
          description: Human-readable event address.
        cityNormalized:
          type: string
          nullable: true
          readOnly: true
          description: Server-computed normalized city for filtering.
        externalUrl:
          type: string
          nullable: true
          description: External link for event details or registration.
        startsAt:
          type: string
          format: date-time
          description: Returned as ISO string. Stored in Firestore as Timestamp.
        endsAt:
          type: string
          format: date-time
          nullable: true
          description: Returned as ISO string. Stored in Firestore as Timestamp.
        published:
          type: boolean
        coverPath:
          type: string
          nullable: true
        assets:
          type: array
          items:
            type: object
            additionalProperties: true
        isWantToVisit:
          type: boolean
          description: Returned when auth context is available.
        createdAt:
          type: string
          format: date-time
          nullable: true
          description: Returned as ISO string or null (never Firestore Timestamp object).
        updatedAt:
          type: string
          format: date-time
          nullable: true
          description: Returned as ISO string or null (never Firestore Timestamp object).
    EventListItem:
      allOf:
        - $ref: '#/components/schemas/EventBase'
      description: Event payload used in list endpoints. Dismissed events are filtered out for authenticated users.
    EventDetail:
      allOf:
        - $ref: '#/components/schemas/EventBase'
        - type: object
          properties:
            isDismissed:
              type: boolean
              description: Returned only for authenticated get-by-id calls.
    Event:
      allOf:
        - $ref: '#/components/schemas/EventDetail'
      description: Backward-compatible alias for event detail schema.

paths:
  /events:
    get:
      tags: [Events]
      summary: List events (MVP1)
      description: |
        Public list of upcoming events.
        Returns only published events with startsAt >= now.
        Past events are excluded from list.
        Events from blocked countries are silently excluded.
        All event timestamps in response payloads are normalized to ISO 8601 strings
        (or null where applicable), including `startsAt`, `endsAt`, `createdAt`, `updatedAt`.
        Authorization header is optional. If provided and valid, response includes user flag `isWantToVisit`
        and excludes dismissed events from the list.
        Guest users can keep local likes/dismiss state in app and sync after login via
        POST /collections/want-to-visit/events/sync.
      operationId: listEvents
      security: []
      parameters:
        - name: country
          in: query
          schema:
            type: string
        - name: Authorization
          in: header
          required: false
          schema:
            type: string
          description: "Optional Bearer token. Example: Bearer <Firebase_ID_TOKEN>."
        - name: city
          in: query
          schema:
            type: string
          description: Server normalizes input and matches against cityNormalized.
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: cursor
          in: query
          schema:
            type: string
          description: Base64 backend cursor. Format v1 `{v:1,startsAt:string,id:string}`. Do not construct client-side.
      responses:
        "200":
          description: Events list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          events:
                            type: array
                            items:
                              $ref: '#/components/schemas/EventListItem'
                      meta:
                        type: object
                        properties:
                          hasMore:
                            type: boolean
                          nextCursor:
                            type: string
                            nullable: true
                          paging:
                            type: string
                            enum: [enabled, end]
              examples:
                upcoming:
                  value:
                    success: true
                    data:
                      events:
                        - id: evt_001
                          name: Kyiv Pop-up Weekend
                          type: pop_up
                          country: Ukraine
                          city: Kyiv
                          address: Kyiv, Khreshchatyk 10
                          cityNormalized: kyiv
                          externalUrl: https://example.com/events/evt_001
                          startsAt: "2026-03-20T10:00:00.000Z"
                          endsAt: "2026-03-20T18:00:00.000Z"
                          createdAt: "2026-03-01T12:00:00.000Z"
                          updatedAt: "2026-03-10T09:30:00.000Z"
                          published: true
                          coverPath: events/evt_001/cover/cover.webp
                          isWantToVisit: false
                    meta:
                      hasMore: false
                      nextCursor: null
                      paging: end
        "400":
          description: Invalid query parameters (`QUERY_INVALID`) or cursor (`CURSOR_INVALID`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "503":
          description: Missing required Firestore composite index (INDEX_NOT_READY).
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /events/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [Events]
      summary: Get event by id
      description: |
        Public endpoint for published events.
        Past events can be opened by direct link, but are excluded from list endpoints.
        All event timestamps are normalized to ISO 8601 strings (or null).
      operationId: getEventById
      security: []
      responses:
        "200":
          description: Event details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          event:
                            $ref: '#/components/schemas/EventDetail'
              examples:
                detail:
                  value:
                    success: true
                    data:
                      event:
                        id: evt_001
                        name: Kyiv Pop-up Weekend
                        type: pop_up
                        country: Ukraine
                        city: Kyiv
                        address: Kyiv, Khreshchatyk 10
                        cityNormalized: kyiv
                        externalUrl: https://example.com/events/evt_001
                        startsAt: "2026-03-20T10:00:00.000Z"
                        endsAt: "2026-03-20T18:00:00.000Z"
                        createdAt: "2026-03-01T12:00:00.000Z"
                        updatedAt: "2026-03-10T09:30:00.000Z"
                        published: true
        "404":
          description: Event not found or unpublished
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /events/{id}/want-to-visit:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      tags: [Events]
      summary: Mark event as want-to-visit
      description: Auth-only. Idempotent. Also removes dismissed state.
      operationId: markEventWantToVisit
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Marked
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          eventId:
                            type: string
                          status:
                            type: string
                            example: want_to_visit
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Event not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
    delete:
      tags: [Events]
      summary: Remove event from want-to-visit
      description: Auth-only. Idempotent.
      operationId: removeEventWantToVisit
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Removed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          eventId:
                            type: string
                          status:
                            type: string
                            example: removed
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /events/{id}/dismiss:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      tags: [Events]
      summary: Dismiss event
      description: Auth-only. Idempotent. Also removes want-to-visit state.
      operationId: dismissEvent
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Dismissed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          eventId:
                            type: string
                          status:
                            type: string
                            example: dismissed
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "404":
          description: Event not found
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
    delete:
      tags: [Events]
      summary: Remove event from dismissed
      description: Auth-only. Idempotent.
      operationId: undismissEvent
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Restored
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          eventId:
                            type: string
                          status:
                            type: string
                            example: restored
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'

  /events/{id}/rsvp:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      tags: [Events]
      summary: RSVP to event
      description: MVP2 only. Not available in MVP1.
      operationId: rsvpEvent
      security:
        - bearerAuth: []
      responses:
        "200":
          description: MVP2-only response shape. In MVP1 runtime this response is never returned.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: './common.yaml#/components/schemas/ApiSuccess'
                  - properties:
                      data:
                        type: object
                        properties:
                          eventId:
                            type: string
                          status:
                            type: string
                            example: RSVPed
        "501":
          description: MVP1 always returns not implemented (`EVENTS_WRITE_MVP2_ONLY`)
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: './common.yaml#/components/schemas/ApiError'
