name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  lint-and-unit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        node: [20]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: Install
        run: npm ci

      - name: Lint (optional)
        run: npm run lint --if-present

      - name: Unit tests
        run: npm run test:unit

      - name: OpenAPI lint
        run: npx @redocly/cli lint docs/openapi.yaml

      - name: Shellcheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: './src/test ./scripts'

      - name: npm audit (high+)
        run: npm audit --audit-level=high

  integration-tests:
    needs: lint-and-unit
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Detect integration secrets
        id: integration-gate
        env:
          TEST_USER_TOKEN: ${{ secrets.TEST_USER_TOKEN || '' }}
          TEST_ADMIN_TOKEN: ${{ secrets.TEST_ADMIN_TOKEN || '' }}
        run: |
          if [ -n "$TEST_USER_TOKEN" ] && [ -n "$TEST_ADMIN_TOKEN" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Integration tests skipped: TEST_USER_TOKEN/TEST_ADMIN_TOKEN not configured"
          fi

      - name: Start server and run integration tests
        if: ${{ steps.integration-gate.outputs.enabled == 'true' }}
        env:
          NODE_ENV: test
          TEST_USER_TOKEN: ${{ secrets.TEST_USER_TOKEN }}
          TEST_ADMIN_TOKEN: ${{ secrets.TEST_ADMIN_TOKEN }}
        run: |
          set -euo pipefail
          NODE_ENV=test node src/core/server.js > /tmp/server.log 2>&1 &
          SERVER_PID=$!

          cleanup() {
            if kill -0 "$SERVER_PID" >/dev/null 2>&1; then
              kill "$SERVER_PID" || true
              wait "$SERVER_PID" || true
            fi
          }
          trap cleanup EXIT

          ready=0
          for i in {1..45}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3005/api/v1/health" || true)
            if [ "$code" = "200" ]; then
              ready=1
              break
            fi
            sleep 1
          done

          if [ "$ready" != "1" ]; then
            echo "Server failed health check"
            echo "---- /tmp/server.log ----"
            cat /tmp/server.log || true
            exit 1
          fi

          ./src/test/run.sh smoke
          ./src/test/run.sh notifications
